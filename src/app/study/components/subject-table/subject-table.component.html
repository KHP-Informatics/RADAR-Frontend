<div class="loading" *ngIf="!isLoaded">
  <mat-spinner></mat-spinner>
</div>

<div class="table" [hidden]="!isLoaded">
  <table
    mat-table
    #table
    [dataSource]="dataSource"
    [trackBy]="trackById"
    matSort
  >
    <ng-container matColumnDef="subjectId">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>
        UUID
      </th>
      <td mat-cell *matCellDef="let row">
        {{ row.login }}
      </td>
    </ng-container>

    <ng-container matColumnDef="humanReadableId">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>
        HRID
      </th>
      <td mat-cell *matCellDef="let row">
        {{ row.externalId }}
      </td>
    </ng-container>

    <ng-container matColumnDef="subjectStatus">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>
        Status
      </th>
      <td mat-cell *matCellDef="let row">
        {{ row.status }}
      </td>
    </ng-container>

    <ng-container matColumnDef="enrolmentDate">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>
        Enrolment Date
      </th>
      <td mat-cell *matCellDef="let row">
        <span class="source-status-icon {{ row.deviceStatus }}"></span>
        {{ row.enrolmentDate | date: 'E LLL d, yyyy' }}
      </td>
    </ng-container>

    <ng-container matColumnDef="lastModifiedDate">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>
        <span
          matTooltip="Last modified in Management Portal"
          matTooltipPosition="above"
          >Last Modified</span
        >
      </th>
      <td mat-cell *matCellDef="let row">
        <span class="source-status-icon {{ row.deviceStatus }}"></span>
        {{ row.lastModifiedDate | date: 'E LLL d, yyyy' }}
      </td>
    </ng-container>

    <ng-container matColumnDef="sources">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>
        Sources
      </th>
      <td mat-cell *matCellDef="let row">
        <span *ngFor="let source of row.sources; let isLast = last">
          {{ source.sourceTypeProducer }}{{ isLast ? '' : ',' }}
        </span>
        <span *ngIf="row.sources.length === 0">NONE</span>
      </td>
    </ng-container>

    <ng-container matColumnDef="lastTaskDate">
      <th mat-header-cell mat-sort-header *matHeaderCellDef>
        <span matTooltip="Last PHQ8 Task" matTooltipPosition="above"
          >Last Task</span
        >
      </th>
      <td mat-cell *matCellDef="let row">
        {{ row.lastTaskDate | date: 'E LLL d, yyyy' }}
      </td>
    </ng-container>

    <ng-container matColumnDef="nextTaskDate">
      <th mat-header-cell mat-sort-header *matHeaderCellDef>
        <span matTooltip="Next PHQ8 Task" matTooltipPosition="above"
          >Next Task</span
        >
      </th>
      <td mat-cell *matCellDef="let row">
        {{ row.nextTaskDate | date: 'E LLL d, yyyy' }}
      </td>
    </ng-container>

    <ng-container matColumnDef="lastResetDate">
      <th mat-header-cell mat-sort-header *matHeaderCellDef>
        <span
          matTooltip="Last reset if any in the last 90 days"
          matTooltipPosition="above"
          >Last Reset</span
        >
      </th>
      <td mat-cell *matCellDef="let row">
        {{ row.lastResetDate | date: 'E LLL d, yyyy' }}
      </td>
    </ng-container>

    <ng-container matColumnDef="lastRemoveDate">
      <th mat-header-cell mat-sort-header *matHeaderCellDef>
        <span
          matTooltip="Last remove if any in the last 90 days"
          matTooltipPosition="above"
          >Last Remove</span
        >
      </th>
      <td mat-cell *matCellDef="let row">
        {{ row.lastRemoveDate | date: 'E LLL d, yyyy' }}
      </td>
    </ng-container>

    <ng-container matColumnDef="appVersion">
      <th mat-header-cell mat-sort-header *matHeaderCellDef>
        <span
          matTooltip="App version from activity in the last 180 days"
          matTooltipPosition="above"
          >App Version</span
        >
      </th>
      <td mat-cell *matCellDef="let row">
        {{ row.appVersion }}
      </td>
    </ng-container>

    <ng-container matColumnDef="lastQuestionnaireFinished">
      <th mat-header-cell mat-sort-header *matHeaderCellDef>
        <span
          matTooltip="Last questionnaire finished in the last 60 days"
          matTooltipPosition="above"
          >Last Questionaire Finished</span
        >
      </th>
      <td mat-cell *matCellDef="let row">
        {{ row.lastQuestionnaireFinished }}
      </td>
    </ng-container>

    <ng-container matColumnDef="lastQuestionnaireFinishedDate">
      <th mat-header-cell mat-sort-header *matHeaderCellDef>
        <span
          matTooltip="Last questionnaire finished in the last 60 days"
          matTooltipPosition="above"
          >Last Questionnaire Finished Date</span
        >
      </th>
      <td mat-cell *matCellDef="let row">
        {{ row.lastQuestionnaireFinishedDate | date: 'E LLL d, yyyy' }}
      </td>
    </ng-container>

    <tbody>
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: displayedColumns"
        (click)="openSubjectHandler($event, row)"
      ></tr>
    </tbody>
  </table>
</div>

<mat-paginator
  #paginator
  [hidden]="!isLoaded"
  [length]="subjectDB.data.length"
  [pageIndex]="0"
  [pageSize]="50"
>
</mat-paginator>
